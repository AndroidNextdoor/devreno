# Static deployment workflow for /dev/reno to GitHub Pages
name: Deploy /dev/reno Static Site to Pages

on:
  # Runs on pushes targeting the default branch
  push:
    branches: ["main"]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Build and deploy static files
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build static version
        run: |
          # Create a static build directory
          mkdir -p dist

          # Copy static HTML files
          cp index.html dist/
          cp jobs.html dist/

          # Copy all assets
          cp -r assets dist/

          # Create a modified jobs.html for static deployment
          sed -i 's|<script src="assets/js/jobs.js" defer></script>||g' dist/jobs.html
          sed -i 's|<script src="assets/js/external-jobs.js" defer></script>||g' dist/jobs.html

          # Add static message for jobs page
          cat >> dist/jobs.html << 'EOF'
          <script>
          document.addEventListener('DOMContentLoaded', function() {
            const jobsLoading = document.getElementById('jobs-loading');
            const externalJobsLoading = document.getElementById('external-jobs-loading');

            if (jobsLoading) {
              jobsLoading.innerHTML = '<div style="text-align: center; padding: 40px;"><h3>Jobs functionality requires server deployment</h3><p>This static version doesn\'t include job search functionality.<br/>For full features, deploy to a Node.js platform like Vercel or Netlify.</p><p><a href="https://github.com/AndroidNextdoor/devreno" target="_blank">View deployment instructions â†’</a></p></div>';
            }

            if (externalJobsLoading) {
              externalJobsLoading.style.display = 'none';
            }
          });
          </script>
          EOF

          # Create README for GitHub Pages
          cat > dist/README.md << 'EOF'
          # /dev/reno - Static Deployment

          This is the static version deployed to GitHub Pages.

          ## Full Version
          For the complete experience including job search functionality, deploy to a platform that supports Node.js:
          - **Vercel**: Connect your GitHub repo for automatic deployment
          - **Netlify**: Enable GitHub integration with environment variables
          - **Heroku**: Deploy with the Node.js buildpack

          ## Local Development
          See the main repository for full setup instructions: https://github.com/AndroidNextdoor/devreno
          EOF

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
